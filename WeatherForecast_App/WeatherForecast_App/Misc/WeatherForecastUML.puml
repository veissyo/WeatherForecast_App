@startuml
top to bottom direction
hide empty members
skinparam packageStyle rectangle
skinparam linetype ortho
legend right
Temat: 5 - Aplikacja pogodowa
end legend

class WeatherCodeHelper
{
    +GetDescription(int code) : string
    +IsThunderstorm(int code) : bool
    +IsHeavyRain(int code) : bool
    +IsFog(int code) : bool
    +IsSnow(int code) : bool  
}

class OpenMeteoEndpoints
{
    FORECAST_API_URL : string
    ARCHIVE_API_URL : string
    GEOCODING_API_URL : string
}
enum ReportType
{
   LOCATION_COMPARISON
   WEEKLY_ALERTS
}
package "W E A T H E R   _   S E R V I C E S"
{
    enum WeatherServiceType
    {
    CURRENT
    DAILY_7
    HOURLY_24
    HISTORICAL
    }
    interface IWeatherService 
    {
        +FetchWeather(LocationData) : Task<WeatherData>
    }
    
    together {
        class CurrentWeatherService
        {
            - _provider : IDataProvider
            + CurrentWeatherService(IDataProvider provider)
            +FetchWeather(LocationData location) : Task<WeatherData>
        }
        
        class DailyWeatherService
        {
            - _provider : IDataProvider
            + DailyWeatherService(IDataProvider provider)
            +FetchWeather(LocationData location) : Task<WeatherData>
        }
        
        class HourlyWeatherService
        {
           - _provider : IDataProvider
            + HourlyWeatherService(IDataProvider provider)
            +FetchWeather(LocationData location) : Task<WeatherData>
        }
        
        class HistoricalWeatherService
        {
            - _provider : IDataProvider
            + HistoricalWeatherService(IDataProvider provider)
            +FetchWeather(LocationData location) : Task<WeatherData>
        }
    }
    class WeatherServiceFactory << (C,orchid) Factory >>
    {
        - _provider : IDataProvider
        + WeatherServiceFactory(IDataProvider provider)
        +CreateWeatherService(WeatherServiceType type) : IWeatherService
    }
    
    HistoricalWeatherService .up.|> IWeatherService
    DailyWeatherService .up.|> IWeatherService
    HourlyWeatherService .up.|> IWeatherService
    CurrentWeatherService .up.|> IWeatherService
    WeatherServiceFactory .up.> HistoricalWeatherService : creates 
    WeatherServiceFactory .up.> CurrentWeatherService : creates 
    WeatherServiceFactory .up.> DailyWeatherService : creates 
    WeatherServiceFactory .up.> HourlyWeatherService : creates 
    WeatherServiceFactory ..> WeatherServiceType : uses
    
}
package "S I N G L E T O N - A P I _ C L I E N T" #Lavender
{
class APIClient << (C,orchid) Singleton >>
{
    - _instance : APIClient
    - _httpClient : HttpClient
    - APIClient()
    + GetInstance() : APIClient
    + GetAsync<T>(string url) : Task<T>
    
}
}

package "S T R A T E G Y - D A T A _ P R O V I D E R" #Lavender
{
    interface IDataProvider << (I,orchid) Strategy >> {
    +GetWeatherData(LocationData location, WeatherServiceType serviceType) : Task<WeatherData>
    }
    together {
        class APIDataProvider
        {
            - _client : APIClient
            + APIDataProvider()
            + GetWeatherData(LocationData location, WeatherServiceType serviceType) : Task<WeatherData>
            + BuildUrl((LocationData location, WeatherServiceType serviceType) : string
        }
        
        class CachedDataProvider
        {
            - _cache : CachedWeatherHistory 
            - _fallbackProvider : IDataProvider
            - _cacheValidityMinutes : int
            + CachedDataProvider(IDataProvider fallbackProvider, int cacheValidityMinutes)
            + GetWeatherData(LocationData location, WeatherServiceType serviceType) : Task<WeatherData>
        }
    }
    APIDataProvider .up.|> IDataProvider
    CachedDataProvider .up.|> IDataProvider
    CachedDataProvider o-up- IDataProvider : fallback
    APIDataProvider ..> APIClient : uses
    APIDataProvider ..> WeatherServiceType : uses
    APIDataProvider .up.> OpenMeteoEndpoints : uses
}

HistoricalWeatherService o-up- IDataProvider
DailyWeatherService o-up- IDataProvider
HourlyWeatherService o-up- IDataProvider
CurrentWeatherService o-up- IDataProvider
WeatherServiceFactory o-up- IDataProvider
 

package "L O C A T I O N" {
class GeolocationService
{
    - _client : APIClient
    + GeolocationService()
    + GetLocation(string cityName) : Task<LocationData>
}

class LocationData
{
    + latitude : double
    + longitude : double
    + LocationData()  
    + LocationData(double lat, double lon) : LocationData
}

class GeocodingResponse
{
    + results : List<LocationData>
}

GeolocationService ..> GeocodingResponse : deserializes
GeolocationService ..> APIClient : uses
GeocodingResponse o-- LocationData
}  
package "D A T A"
{

together {
    abstract class WeatherData
    {
        + latitude : double
        + longitude : double
        + timezone : string
        
        + GetLocation() : LocationData
        + GetSummary() : string
    }
    class CurrentWeatherData
    {
        + time : string
        + temperature_2m : double
        + rain : double
        + snowfall : double
        + apparent_temperature : double
        + cloud_cover : double
        + wind_speed_10m : double
        + weather_code : int
        
        + GetSummary() : string
    }
    
    class CurrentWeatherResponse
    {
        + latitude : double
        + longitude : double
        + timezone : string
        + current : CurrentWeatherData
    }
    
    class HourlyWeatherData
    {
        + time : string[]
        + temperature_2m : double[]
        + rain : double[]
        + snowfall : double[]
        + cloud_cover : double[]
        + wind_speed_10m : double[]
        + weather_code : int[]
                
        + GetSummary() : string
    }
    
    class HourlyWeatherResponse
    {
            + latitude : double
            + longitude : double
            + timezone : string
            + hourly : HourlyWeatherData
    }
    
    class DailyWeatherData 
    {
        + time : string[]
        + temperature_2m_max : double[]
        + temperature_2m_min : double[]
        + rain_sum : double[]
        + snowfall_sum : double[]
        + wind_speed_10m_max : double[]
        
        + GetSummary() : string
    }
    
     class DailyWeatherResponse
    {
        + latitude : double
        + longitude : double
        + timezone : string
        + daily : DailyWeatherData
    }
    
    class HistoricalWeatherData
    {
        + start_date : string[]
        + end_date : string[]
        + daily : DailyWeatherData
        + HistoricalWeatherData()
        + GetSummary() : string
    }
    
     class HistoricalWeatherResponse
    {
        + latitude : double
        + longitude : double
        + timezone : string
        + daily : DailyWeatherData
    }
    HourlyWeatherResponse *-- HourlyWeatherData
    CurrentWeatherResponse *-- CurrentWeatherData
    DailyWeatherResponse *-- DailyWeatherData
    HistoricalWeatherResponse *-- DailyWeatherData 
    HistoricalWeatherData *-- DailyWeatherData : contains
    HourlyWeatherData --|> WeatherData
    CurrentWeatherData --|> WeatherData
    HistoricalWeatherData --|> WeatherData
    DailyWeatherData --|> WeatherData
    APIDataProvider ..> HourlyWeatherResponse : deserializes
    APIDataProvider ..> CurrentWeatherResponse : deserializes 
    APIDataProvider ..> HistoricalWeatherResponse : deserializes
    APIDataProvider ..> DailyWeatherResponse : deserializes
    CurrentWeatherData ..> WeatherCodeHelper 
    HourlyWeatherData ..> WeatherCodeHelper 
    
}
}
package "M E M E N T O - C A C H E" #Lavender
{
class WeatherHistoryMemento << (C,orchid) Memento >> {
    +Data : WeatherData
    +Timestamp : DateTime
    +Location : LocationData
    +ServiceType : WeatherServiceType
    + WeatherHistoryMemento(WeatherData data, LocationData location, WeatherServiceType service)
}

class CachedWeatherHistory
{
    - _history : Dictionary<string, List<WeatherHistoryMemento>>
    + CachedWeatherHistory()
    + SaveState(WeatherData data, LocationData location, WeatherServiceType serviceType) : void
    + GetLast(LocationData location, WeatherServiceType serviceType) : WeatherHistoryMemento
    + GetLocationKey(LocationData location, WeatherServiceType serviceType) : string
    + CleanOldData(string key) : void
}
CachedDataProvider *-- CachedWeatherHistory
CachedWeatherHistory *-- WeatherHistoryMemento : keeps
WeatherHistoryMemento ..> WeatherServiceType : uses
WeatherHistoryMemento o-- LocationData 
WeatherHistoryMemento o-- WeatherData 
}

package "O B S E R V E R - W A T C H E D _ L O C A T I O N" #Lavender
{
interface IWeatherObserver << (I,orchid) Observer >>
{
    + Update(WeatherData data) : void
}

interface ISubject
{
    + Attach(IWeatherObserver observer) : void
    + Detach(IWeatherObserver observer) : void
    +Notify() : void
}

class WatchedLocation
{
    + _locationData : LocationData
    - _observers : List<IWeatherObserver>
    - _currentWeather : CurrentWeatherData
    - _forecast : DailyWeatherData
    + WatchedLocation(LocationData location)
    +Attach(IWeatherObserver observer) : void
    +Detach(IWeatherObserver observer) : void
    +Notify() : void
    + UpdateWeather(CurrentWeatherData current, DailyWeatherData forecast = null)
}
WatchedLocation o-- IWeatherObserver
WatchedLocation ..|> ISubject
WatchedLocation o-- CurrentWeatherData 
WatchedLocation o-- DailyWeatherData 
WatchedLocation o-- LocationData

}

package "A L E R T S"
{
class WeatherAlert 
{
    #_locationName string
    #_isEnabled bool
    #WeatherAlert(string LocationName)
    #CheckCondition(WeatherData data) : bool
    #GetAlertMessage(WeatherData data) : string
    #SendAlert : void
    +Update : void
}
together {
    class TemperatureAlert
    {
    - _threshold : double
    - _isAbove : bool
    + TemperatureAlert(string location, double threshold, bool isAbove)
    #CheckCondition(WeatherData data) : bool
    #GetAlertMessage(WeatherData data) : string
    }
    class ThunderstormAlert
    {
    + ThunderstormAlert(string location)
    #CheckCondition(WeatherData data) : bool
    #GetAlertMessage(WeatherData data) : string
    }
    class FloodAlert
    {
    + FloodAlert(string location)
    #CheckCondition(WeatherData data) : bool
    #GetAlertMessage(WeatherData data) : string
    }
    class SnowAlert
    {
        + SnowAlert(string location)
        #CheckCondition(WeatherData data) : bool
        #GetAlertMessage(WeatherData data) : string
    }
    class FogAlert
    {
        + FogAlert(string location)
        #CheckCondition(WeatherData data) : bool
        #GetAlertMessage(WeatherData data) : string
    }
    class GlazedFrostAlert
    {
        + GlazedFrostAlert(string location)
        #CheckCondition(WeatherData data) : bool
        #GetAlertMessage(WeatherData data) : string
    }
}
WeatherAlert .up.|> IWeatherObserver
FogAlert -up-|> WeatherAlert
SnowAlert -up-|> WeatherAlert
GlazedFrostAlert -up-|> WeatherAlert
FloodAlert -up-|> WeatherAlert
TemperatureAlert -up-|> WeatherAlert
ThunderstormAlert -up-|> WeatherAlert
FogAlert .up.> CurrentWeatherData  
SnowAlert .up.> CurrentWeatherData 
GlazedFrostAlert .up.> CurrentWeatherData 
FloodAlert .up.> CurrentWeatherData 
TemperatureAlert .up.> CurrentWeatherData 
ThunderstormAlert .up.> CurrentWeatherData 
FogAlert .down.> WeatherCodeHelper 
SnowAlert .down.> WeatherCodeHelper 
GlazedFrostAlert .down.> WeatherCodeHelper 
FloodAlert .down.> WeatherCodeHelper
TemperatureAlert .down.> WeatherCodeHelper
ThunderstormAlert .down.> WeatherCodeHelper 
}


package "B U I L D E R - R E P O R T S" #Lavender
{
class WeatherReport
{
    + Title : string
    + Type : ReportType
    + Content : string
    + GeneratedAt : DateTime 
    + Location : LocationData
    +WeatherReport(ReportType type)
    +ToString() : string
}

interface IWeatherReportBuilder << (I,orchid) Builder >>
{
    + Reset(); : IWeatherReportBuilder
    + SetLocation(LocationData location) : IWeatherReportBuilder
    + SetTitle(string title) : IWeatherReportBuilder
    + SetType(ReportType type) : IWeatherReportBuilder
    +AddComparisonHeader(string city1, string city2, int days) : IWeatherReportBuilder
    + AddLocationWeatherSummary(string cityName, LocationData location, DailyWeatherData data) : IWeatherReportBuilder
    +AddComparisonSummary(DailyWeatherData data1, DailyWeatherData data2, string city1, string city2) : IWeatherReportBuilder
    +AddAlertsHeader(string cityName, int days, int alertCount) : IWeatherReportBuilder
    +AddDailyConditions(DailyWeatherData data) : IWeatherReportBuilder
    +AddAlertsSummary(List<WeatherAlert> alerts) : IWeatherReportBuilder
    + AddPotentialHazards(DailyWeatherData data) : IWeatherReportBuilder
    +GetResult() : WeatherReport
}

class WeatherReportBuilder 
{
    - _report : WeatherReport
    - _weatherData : List<WeatherData>
    - _location : LocationData
    + WeatherReportBuilder(ReportType type)
   + Reset(); : IWeatherReportBuilder
       + SetLocation(LocationData location) : IWeatherReportBuilder
       + SetTitle(string title) : IWeatherReportBuilder
       + SetType(ReportType type) : IWeatherReportBuilder
       +AddComparisonHeader(string city1, string city2, int days) : IWeatherReportBuilder
       + AddLocationWeatherSummary(string cityName, LocationData location, DailyWeatherData data) : IWeatherReportBuilder
       +AddComparisonSummary(DailyWeatherData data1, DailyWeatherData data2, string city1, string city2) : IWeatherReportBuilder
       +AddAlertsHeader(string cityName, int days, int alertCount) : IWeatherReportBuilder
       +AddDailyConditions(DailyWeatherData data) : IWeatherReportBuilder
       +AddAlertsSummary(List<WeatherAlert> alerts) : IWeatherReportBuilder
       + AddPotentialHazards(DailyWeatherData data) : IWeatherReportBuilder
       +GetResult() : WeatherReport
       - CalculateAverageTemp(DailyWeatherData data) : double
}

class ReportDirector
{
    - _builder : IWeatherReportBuilder
    + ReportDirector(IWeatherReportBuilder builder)
    + BuildLocationComparisonReport(LocationData location1, LocationData location2, 
              DailyWeatherData data1, DailyWeatherData data2, string city1, string city2) : WeatherReport
    +  BuildWeeklyAlertsReport(LocationData location, DailyWeatherData data, 
              string cityName, List<WeatherAlert> alerts) : WeatherReport
}
WeatherReportBuilder ..|> IWeatherReportBuilder
WeatherReportBuilder o-- WeatherReport
WeatherReport ..> ReportType : uses
WeatherReport o-- LocationData
ReportDirector o-- IWeatherReportBuilder
WeatherReportBuilder o-- WeatherData
WeatherReportBuilder o-- LocationData
}

package "S T R A T E G Y - A N A L Y S I S" #Lavender 
{
    interface IWeatherAnalysis
    {
        + Analyze(DailyWeatherData data) : string
    }
    
    class WeatherAnalyzer
    {
        - _strategy : IWeatherAnalysis
        + SetStrategy(IWeatherAnalysis strategy) : void
        + PerformAnalysis(DailyWeatherData data) : string
    }
    
    class Precipitation
    {
        + Analyze(DailyWeatherData data) : string
    }
    
    class TemperatureTrend
    {
            + Analyze(DailyWeatherData data) : string
            - CalculateTrend(double[] temps) : string
    }
}

WeatherAnalyzer o--> IWeatherAnalysis
 WeatherAnalyzer ..> DailyWeatherData  
Precipitation ..|> IWeatherAnalysis
TemperatureTrend ..|> IWeatherAnalysis
Precipitation ..> DailyWeatherData                                
TemperatureTrend ..> DailyWeatherData  



package "I M P O R T / E X P O R T" 
{
    class JSONDataExporter
    {
        - _options : JsonSerializerOptions
        + JSONDataExporter()
        + ExportWeatherData(WeatherData data, string filePath, string cityName) : Task
        + ExportWatchedLocations(Dictionary<string, WatchedLocation> locations, string filePath) : Task
        + ExportWeatherReport(WeatherReport report, string filePath) : Task
        
    }
    
    class JSONDataImporter
    {
        + ImportWeatherData(string filePath) : Task<WeatherData?>
        - DeserializeHistoricalData(JsonElement weatherDataElement, double latitude, double longitude, string timezone) : HistoricalWeatherData
        + ImportWatchedLocations(string filePath) : Task<Dictionary<string, LocationData>?>
    }
}

JSONDataExporter ..> WeatherData
JSONDataExporter ..> CurrentWeatherData
JSONDataExporter ..> DailyWeatherData
JSONDataExporter ..> HistoricalWeatherData
JSONDataExporter ..> HourlyWeatherData
JSONDataExporter ..> WatchedLocation
JSONDataExporter ..> WeatherAlert
JSONDataExporter ..> WeatherReport
JSONDataExporter ..> LocationData

JSONDataImporter ..> WeatherData
JSONDataImporter ..> CurrentWeatherData
JSONDataImporter ..> DailyWeatherData
JSONDataImporter ..> HistoricalWeatherData
JSONDataImporter ..> HourlyWeatherData
JSONDataImporter ..> LocationData


package "F A C A D E"  #Lavender
{
class WeatherForecastApp << (C,orchid) Facade >>
{
    - _dataProvider : IDataProvider
    - _serviceFactory : WeatherServiceFactory
    - _geoService : GeoLocationService
    - _watchedLocations : Dictionary<string, WatchedLocation>
    - _analyzer : WeatherAnalyzer
    - _exporter : JSONDataExporter
    - _importer : JSONDataImporter
    - _lastWeatherData : WeatherData
    -  _lastCityName : string
    - _lastReport : WeatherReport
    + WeatherForecastApp()
    + ShowMenu() 
    + GetWeatherForCity(string cityName) : Task<CurrentWeatherData?> 
    + GetForecast(string cityName, int days) : Task<DailyWeatherData?> 
    +  GetHourlyForecast(string cityName) : Task<HourlyWeatherData?>
    + GetHistoricalWeather(string cityName) : Task<HistoricalWeatherData?> 
    +  AddWatchedLocation(string cityName) :  Task<WatchedLocation?>
    + AddAlertToLocation(string cityName, WeatherAlert alert) : Task
    + UpdateAllWatchedLocations() : Task
    + ShowWatchedLocations() 
    + RemoveWatchedLocation(string cityName)
    + PerformPrecipitationAnalysis(string cityName) : Task
    + PerformTemperatureTrendAnalysis(string cityName) : Task
    + GenerateLocationComparisonReport(string city1, string city2) : Task
    + GenerateWeeklyAlertsReport(string cityName) : Task
    +  GetWatchedLocationNames() : List<string>
    + ExportLastWeatherData() : Task
    + ExportWatchedLocations() : Task
    + ExportLastReport() : Task
    + ImportWeatherData(string filePath) : Task
    + ImportWatchedLocations(string filePath) : Task
  
}

}

WeatherForecastApp *-down- WeatherServiceFactory  
WeatherForecastApp *-down- GeolocationService 
 WeatherForecastApp ..> ReportDirector 
WeatherForecastApp *-down- CachedDataProvider 
WeatherForecastApp o-down- WatchedLocation 
ReportDirector ..> CurrentWeatherData
ReportDirector ..> DailyWeatherData
ReportDirector ..> HourlyWeatherData
ReportDirector ..> HistoricalWeatherData
GeolocationService ..> OpenMeteoEndpoints 
WeatherData ..> LocationData 
IWeatherService ..> LocationData
IDataProvider ..> LocationData
WeatherForecastApp *-- WeatherAnalyzer
WeatherForecastApp ..> Precipitation
WeatherForecastApp ..> TemperatureTrend
WeatherForecastApp *-- JSONDataExporter
WeatherForecastApp *-- JSONDataImporter
WeatherForecastApp o-- WeatherReport   
WeatherForecastApp o-- WeatherData   
 WeatherForecastApp o-- IDataProvider 
 
 class Program
 {
    +Main() : Task 
 }

Program o-- WeatherForecastApp     



@enduml